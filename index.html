<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Mapa de Envueltos Tradicionales del Ecuador</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: 'Google Sans', Roboto, Arial, sans-serif;
  background: #f6f8fc;
  margin: 0;
  color: #202124;
}
main {
  max-width: 900px;
  margin: 2rem auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 2rem;
}
h1 {
  font-size: 1.8rem;
  text-align: center;
  color: #1a73e8;
}
section {
  border-top: 2px solid #e0e0e0;
  padding-top: 1rem;
  margin-top: 1.5rem;
}
label {
  display: block;
  margin-top: .8rem;
  font-weight: 500;
}
input[type=text], input[type=number], select, textarea {
  width: 100%;
  padding: .6rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: .3rem;
}
textarea { min-height: 70px; }

.inline {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  margin-top: .5rem;
}

.chip {
  display: inline-flex;
  align-items: center;
  padding: .45rem .9rem;
  border-radius: 30px;
  border: 1px solid #ccc;
  background: #f1f3f4;
  cursor: pointer;
  transition: 0.2s;
}
.chip input { display: none; }
.chip.active {
  background: #1a73e8;
  color: white;
  border-color: #1a73e8;
}
.envuelto-card {
  background: #f9fbff;
  border: 2px solid #cfe3ff;
  border-radius: 10px;
  padding: 1rem;
  margin-top: 1rem;
}
.envuelto-card legend {
  font-weight: 600;
  color: #1a73e8;
}
button {
  background: #1a73e8;
  color: white;
  border: none;
  border-radius: 8px;
  padding: .8rem 1.4rem;
  cursor: pointer;
  margin-top: 1.5rem;
  font-size: 1rem;
  font-weight: 500;
}
button:hover { background: #1669c1; }

.success {
  background: #e6f4ea;
  color: #0f9d58;
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
  margin-top: 1rem;
}
.error {
  background: #fce8e6;
  color: #d93025;
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
  margin-top: 1rem;
}
</style>
</head>
<body>
<main>
<h1>Mapa de Envueltos Tradicionales del Ecuador</h1>
<p>Esta encuesta tiene fines académicos y de investigación. La información será tratada de forma confidencial.</p>

<form id="encuesta">

<section>
<h2>Datos Generales</h2>
<label>Nombres completos *</label><input id="nombre" type="text" required>
<label>Edad *</label><input id="edad" type="number" required>
<label>Género *</label>
<select id="genero" required>
<option value="">Seleccione</option>
<option>Femenino</option><option>Masculino</option><option>Otro</option>
</select>
<label>Región *</label>
<select id="region" required>
<option value="">Seleccione</option><option>Costa</option><option>Sierra</option><option>Amazonía</option><option>Insular</option>
</select>
<label>Provincia *</label><input id="provincia" type="text" required>
<label>Ciudad *</label><input id="ciudad" type="text" required>
<label>Actividad principal *</label>
<select id="actividad" required>
<option value="">Seleccione</option>
<option>Cocinero/a tradicional</option><option>Docente de gastronomía</option><option>Promotor/a cultural</option><option>Chef</option>
</select>
<label>Tiempo de experiencia *</label><input id="experiencia" type="text" required>
</section>

<section>
<h2>Información de los envueltos</h2>
<p>Selecciona los envueltos que conoces o preparas. Se generará un bloque de preguntas por cada uno.</p>
<div id="lista-envueltos" class="inline"></div>
<div class="inline" style="margin-top:1rem;">
  <label class="chip"><input type="checkbox" id="otros-chk">Otros</label>
  <input type="text" id="otros-text" placeholder="Especifique (use coma si son varios)" hidden>
</div>
<div id="contenedor-envueltos"></div>
</section>

<section>
<h2>Cierre</h2>
<label>¿Quiénes transmiten estos conocimientos?</label>
<div class="inline">
<label class="chip"><input type="checkbox">Docentes o estudiantes</label>
<label class="chip"><input type="checkbox">Instituciones educativas</label>
<label class="chip"><input type="checkbox">Cocineros/as tradicionales</label>
<label class="chip"><input type="checkbox">Madres/abuelas</label>
<label class="chip"><input type="checkbox">Museos gastronómicos</label>
<label class="chip"><input type="checkbox">Medios digitales</label>
</div>
<input type="text" placeholder="Otros: especifique">
<label>¿Qué ingredientes varían según la región?</label>
<textarea></textarea>
<label>¿Ha observado transformaciones en la preparación o consumo?</label>
<textarea></textarea>
<label>¿Qué estrategias usa para conservar y transmitir estos conocimientos?</label>
<textarea></textarea>
</section>

<button type="submit">Enviar</button>
<div id="mensaje"></div>

</form>
</main>

<!-- Template de preguntas por envuelto -->
<template id="tpl-envuelto">
<fieldset class="envuelto-card">
<legend></legend>
<label>Tipo de masa/base:</label><input type="text" placeholder="Ej. maíz, verde, yuca...">
<label>Relleno que se utiliza:</label><input type="text" placeholder="Ej. pollo, cerdo, queso...">
<label>Tipo de hoja que se usa:</label><input type="text" placeholder="Ej. hoja de achira, plátano...">
<label>Técnica de cocción:</label><input type="text" placeholder="Ej. hervido, al vapor...">
<label>Herramienta que se usa:</label><input type="text" placeholder="Ej. olla de barro, vaporera...">
<label>Contexto tradicional de preparación:</label><input type="text" placeholder="Ej. festividades, celebraciones familiares...">
</fieldset>
</template>

<script>
const ENVUELTOS = ["Humita","Chigüil","Quimbolito","Tamal serrano","Tamal lojano","Tamal manaba","Bollo de pescado","Ayaca","Muchín de yuca","Envuelto de verde","Envuelto de arroz"];
const lista = document.getElementById("lista-envueltos");
const tpl = document.getElementById("tpl-envuelto");
const contenedor = document.getElementById("contenedor-envueltos");
const otrosChk = document.getElementById("otros-chk");
const otrosTxt = document.getElementById("otros-text");

// Crear chips de envueltos
ENVUELTOS.forEach(n => {
  const chip = document.createElement("label");
  chip.className = "chip";
  chip.innerHTML = `<input type="checkbox" value="${n}"><span>${n}</span>`;
  lista.appendChild(chip);
});

// Eventos
lista.addEventListener("change", actualizar);
otrosChk.addEventListener("change", () => {
  otrosTxt.hidden = !otrosChk.checked;
  actualizar();
});
otrosTxt.addEventListener("input", actualizar);

// Función que genera grupos de preguntas dinámicamente
function actualizar() {
  contenedor.innerHTML = "";
  let seleccionados = [];

  lista.querySelectorAll("input[type=checkbox]").forEach(ch => {
    const chip = ch.closest(".chip");
    chip.classList.remove("active");
    if (ch.checked) {
      chip.classList.add("active");
      seleccionados.push(ch.value);
    }
  });

  if (otrosChk.checked && otrosTxt.value.trim()) {
    const otros = otrosTxt.value.split(",").map(x => x.trim()).filter(Boolean);
    seleccionados = seleccionados.concat(otros);
  }

  seleccionados.forEach(nombre => {
    const clone = tpl.content.firstElementChild.cloneNode(true);
    clone.querySelector("legend").textContent = "Envuelto: " + nombre;
    contenedor.appendChild(clone);
  });
}

// Envío de datos
document.getElementById("encuesta").addEventListener("submit", function(e) {
  e.preventDefault();
  const msg = document.getElementById("mensaje");
  msg.innerHTML = "";

  const data = {
    nombres: nombre.value,
    edad: edad.value,
    genero: genero.value,
    region: region.value,
    provincia: provincia.value,
    ciudad: ciudad.value,
    actividad: actividad.value,
    experiencia: experiencia.value,
    envueltosSeleccionados: [],
    respuestasPorEnvuelto: {}
  };

  lista.querySelectorAll("input[type=checkbox]:checked").forEach(ch => data.envueltosSeleccionados.push(ch.value));

  contenedor.querySelectorAll(".envuelto-card").forEach(card => {
    const envuelto = card.querySelector("legend").textContent.replace("Envuelto: ","");
    const inputs = card.querySelectorAll("input[type=text]");
    data.respuestasPorEnvuelto[envuelto] = {
      masa: inputs[0].value,
      relleno: inputs[1].value,
      hoja: inputs[2].value,
      tecnica: inputs[3].value,
      herramienta: inputs[4].value,
      contexto: inputs[5].value
    };
  });

  fetch("https://script.google.com/macros/s/AKfycbyfD5T0MOyMdK7FeqiIUfr_Zb7Ogz6LJMbbUU8nZa0OnwtuHmm1Z02hcw1Q-7sj24AoQA/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" },
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      msg.innerHTML = '<div class="success">✅ ¡Gracias! Tus respuestas se guardaron correctamente.</div>';
      e.target.reset();
      contenedor.innerHTML = "";
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    } else {
      msg.innerHTML = '<div class="error">❌ Error al guardar: '+(res.error||'Intente nuevamente')+'</div>';
    }
  })
  .catch(() => {
    msg.innerHTML = '<div class="error">❌ No se pudo conectar con el servidor.</div>';
  });
});
</script>
</body>
</html>
